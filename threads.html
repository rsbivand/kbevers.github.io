
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Threads &mdash; proj.4 4.9.2 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootswatch-3.3.6/paper/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4.9.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="proj.4 4.9.2 documentation" href="index.html" />
    <link rel="next" title="Parameters" href="parameters.html" />
    <link rel="prev" title="HTPD" href="htpd.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          proj.4</a>
        <span class="navbar-text navbar-version pull-left"><b>4.9.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="download.html">Download</a></li>
                <li><a href="https://github.com/OSGeo/proj.4">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Docs <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="download.html">Download</a><ul>
<li class="toctree-l2"><a class="reference internal" href="download.html#current-release">Current Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="download.html#past-releases">Past Releases</a></li>
<li class="toctree-l2"><a class="reference internal" href="download.html#binaries">Binaries</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="faq.html#where-can-i-find-the-list-of-projections-and-their-arguments">Where can I find the list of projections and their arguments?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-do-i-build-configure-proj-4-to-support-datum-shifting">How do I build/configure PROJ.4 to support datum shifting?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-do-i-debug-problems-with-nad27-nad83-datum-shifting">How do I debug problems with NAD27/NAD83 datum shifting?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-do-i-use-epsg-coordinate-system-codes-with-proj-4">How do I use EPSG coordinate system codes with PROJ.4?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-do-i-use-3-parameter-and-7-parameter-datum-shifting">How do I use 3 parameter and 7 parameter datum shifting</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#does-proj-4-work-in-different-international-numeric-locales">Does PROJ.4 work in different international numeric locales?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#changing-ellipsoid-why-can-t-i-convert-from-wgs84-to-google-earth-virtual-globe-mercator">Changing Ellipsoid / Why can&#8217;t I convert from WGS84 to Google Earth / Virtual Globe Mercator?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#why-do-i-get-different-results-with-4-5-0-and-4-6-0">Why do I get different results with 4.5.0 and 4.6.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-do-i-calculate-distances-directions-on-the-surface-of-the-earth">How do I calculate distances/directions on the surface of the earth?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#what-is-the-healpix-projection-and-how-can-i-use-it">What is the HEALPix projection and how can I use it?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#what-is-the-rhealpix-projection-and-how-can-i-use-it">What is the rHEALPix projection and how can I use it?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#what-options-does-proj-4-allow-for-the-shape-of-the-earth-geodesy">What options does proj.4 allow for the shape of the Earth (geodesy)?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#what-if-i-want-a-spherical-earth">What if I want a spherical Earth?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-do-i-change-the-radius-of-the-earth-how-do-i-use-proj-4-for-work-on-mars">How do I change the radius of the Earth?  How do I use proj.4 for work on Mars?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-do-i-do-false-eastings-and-false-northings">How do I do False Eastings and False Northings?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="geodesic.html">Geodesic Calculations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="geodesic.html#id1">Geodesic Calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="geodesic.html#terminology">Terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="geodesic.html#the-math">The Math</a></li>
<li class="toctree-l2"><a class="reference internal" href="geodesic.html#the-history">The History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="grids.html">Grids</a><ul>
<li class="toctree-l2"><a class="reference internal" href="grids.html#us-canadian-french-and-new-zealand">US, Canadian, French and New Zealand</a></li>
<li class="toctree-l2"><a class="reference internal" href="grids.html#switzerland">Switzerland</a></li>
<li class="toctree-l2"><a class="reference internal" href="grids.html#harn">HARN</a></li>
<li class="toctree-l2"><a class="reference internal" href="grids.html#htdp">HTDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="grids.html#non-free-grids">Non-Free Grids</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="htpd.html">HTPD</a><ul>
<li class="toctree-l2"><a class="reference internal" href="htpd.html#getting-and-building-htdp">Getting and building HTDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="htpd.html#getting-crs2crs2grid-py">Getting crs2crs2grid.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="htpd.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="htpd.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Threads</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#key-thread-safety-issues">Key Thread Safety Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="#projctx">projCtx</a></li>
<li class="toctree-l2"><a class="reference internal" href="#src-multistresstest-c">src/multistresstest.c</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="parameters.html">Parameters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#parameter-list">Parameter list</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#units">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#vertical-units">Vertical Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#false-easting-northing">False Easting/Northing</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#lon-wrap-over-longitude-wrapping">lon_wrap, over - Longitude Wrapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#pm-prime-meridian">pm - Prime Meridian</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#towgs84-datum-transformation-to-wgs84">towgs84 - Datum transformation to WGS84</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#nadgrids-grid-based-datum-adjustments">nadgrids - Grid Based Datum Adjustments</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#axis-orientation">Axis orientation</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Here <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Threads</a><ul>
<li><a class="reference internal" href="#key-thread-safety-issues">Key Thread Safety Issues</a></li>
<li><a class="reference internal" href="#projctx">projCtx</a></li>
<li><a class="reference internal" href="#src-multistresstest-c">src/multistresstest.c</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="htpd.html" title="Previous Chapter: HTPD"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; HTPD</span>
    </a>
  </li>
  <li>
    <a href="parameters.html" title="Next Chapter: Parameters"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Parameters &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="threads">
<span id="id1"></span><h1>Threads<a class="headerlink" href="#threads" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#threads" id="id2">Threads</a><ul>
<li><a class="reference internal" href="#key-thread-safety-issues" id="id3">Key Thread Safety Issues</a></li>
<li><a class="reference internal" href="#projctx" id="id4">projCtx</a></li>
<li><a class="reference internal" href="#src-multistresstest-c" id="id5">src/multistresstest.c</a></li>
</ul>
</li>
</ul>
</div>
<p>This page is about efforts to make PROJ.4 thread safe.</p>
<div class="section" id="key-thread-safety-issues">
<h2>Key Thread Safety Issues<a class="headerlink" href="#key-thread-safety-issues" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>the global pj_errno variable is shared between threads and makes it
essentially impossible to handle errors safely.  Being addressed with the
introduction of the projCtx execution context.</li>
<li>the datum shift using grid files uses globally shared lists of loaded grid
information. Access to this has been made safe in 4.7.0 with the introduction
of a proj.4 mutex used to protect access to these memory structures (see
pj_mutex.c).</li>
</ul>
</div>
<div class="section" id="projctx">
<h2>projCtx<a class="headerlink" href="#projctx" title="Permalink to this headline">¶</a></h2>
<p>Primarily in order to avoid having pj_errno as a global variable, a &#8220;thread
context&#8221; structure has been introduced into a variation of the PROJ.4 API for
the 4.8.0 release.  The pj_init() and pj_init_plus() functions now have context
variations called pj_init_ctx() and pj_init_plus_ctx() which take a projections
context.</p>
<p>The projections context can be created with pj_ctx_alloc(), and there is a
global default context used when one is not provided by the application.  There
is a <a href="#id6"><span class="problematic" id="id7">pj_ctx_</span></a> set of functions to create, manipulate, query, and destroy
contexts.  The contexts are also used now to handle setting debugging mode, and
to hold an error reporting function for textual error and debug messages.   The
API looks like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">projPJ</span> <span class="n">pj_init_ctx</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span> <span class="p">);</span>
<span class="n">projPJ</span> <span class="n">pj_init_plus_ctx</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span> <span class="p">);</span>

<span class="n">projCtx</span> <span class="n">pj_get_default_ctx</span><span class="p">(</span><span class="n">void</span><span class="p">);</span>
<span class="n">projCtx</span> <span class="n">pj_get_ctx</span><span class="p">(</span> <span class="n">projPJ</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_set_ctx</span><span class="p">(</span> <span class="n">projPJ</span><span class="p">,</span> <span class="n">projCtx</span> <span class="p">);</span>
<span class="n">projCtx</span> <span class="n">pj_ctx_alloc</span><span class="p">(</span><span class="n">void</span><span class="p">);</span>
<span class="n">void</span>    <span class="n">pj_ctx_free</span><span class="p">(</span> <span class="n">projCtx</span> <span class="p">);</span>
<span class="nb">int</span> <span class="n">pj_ctx_get_errno</span><span class="p">(</span> <span class="n">projCtx</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_ctx_set_errno</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="nb">int</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_ctx_set_debug</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="nb">int</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_ctx_set_logger</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">void</span> <span class="o">*</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">pj_ctx_set_app_data</span><span class="p">(</span> <span class="n">projCtx</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span> <span class="p">);</span>
<span class="n">void</span> <span class="o">*</span><span class="n">pj_ctx_get_app_data</span><span class="p">(</span> <span class="n">projCtx</span> <span class="p">);</span>
</pre></div>
</div>
<p>Multithreaded applications are now expected to create a projCtx per thread
using pj_ctx_alloc().  The context&#8217;s error handlers, and app data may be
modified if desired, but at the very least each context has an internal error
value accessed with pj_ctx_get_errno() as opposed to looking at pj_errno.</p>
<p>Note that pj_errno continues to exist, and it is set by pj_ctx_set_errno() (as
well as setting the context specific error number), but pj_errno still suffers
from the global shared problem between threads and should not be used by
multithreaded applications.</p>
<p>Note that pj_init_ctx(), and pj_init_plus_ctx() will assign the projCtx to the
created projPJ object.  Functions like pj_transform(), pj_fwd() and pj_inv()
will use the context of the projPJ for error reporting.</p>
</div>
<div class="section" id="src-multistresstest-c">
<h2>src/multistresstest.c<a class="headerlink" href="#src-multistresstest-c" title="Permalink to this headline">¶</a></h2>
<p>A small multi-threaded test program has been written (src/multistresstest.c)
for testing multithreaded use of PROJ.4.  It performs a series of reprojections
to setup a table expected results, and then it does them many times in several
threads to confirm that the results are consistent.  At this time this program
is not part of the builds but it can be built on linux like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">gcc</span> <span class="o">-</span><span class="n">g</span> <span class="n">multistresstest</span><span class="o">.</span><span class="n">c</span> <span class="o">.</span><span class="n">libs</span><span class="o">/</span><span class="n">libproj</span><span class="o">.</span><span class="n">so</span> <span class="o">-</span><span class="n">lpthread</span> <span class="o">-</span><span class="n">o</span> <span class="n">multistresstest</span>
<span class="o">./</span><span class="n">multistresstest</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
    <div class="footer">
        <div class="container">
                    &copy;  1986?-2016
                        Gerald Evenden,
                        <a href="https://github.com/warmerdam">Frank Warmerdam</a>,
                        and
                        <a href="https://github.com/OSGeo/proj.4/graphs/contributors">others</a>,
                Last updated
                    on 18 Jun 2016.
        </div>
    </div>
  </body>
</html>